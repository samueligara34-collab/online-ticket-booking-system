// Save as: TicketBookingApp.java
import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.awt.event.*;
import java.io.*;
import java.text.SimpleDateFormat;
import java.util.*;
import java.util.List;
import java.util.concurrent.*;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.locks.ReentrantLock;

/**
 * Single-file GUI + backend Ticket Booking App
 * - Swing GUI: Login -> User Panel / Admin Panel
 * - Thread-safe backend with per-ticket locks
 * - Multithreaded simulation
 * - Logs: user_log.txt, admin_log.txt, simulation_log.txt, system_log.txt
 * - Persistent session counter and cumulative totals
 */
public class TicketBookingApp {

    // ---------- Persistence files ----------
    private static final String USER_LOG = "user_log.txt";
    private static final String ADMIN_LOG = "admin_log.txt";
    private static final String SIM_LOG = "simulation_log.txt";
    private static final String MASTER_LOG = "system_log.txt";
    private static final String SESSION_COUNTER_FILE = "session_counter.txt";
    private static final String CUMULATIVE_FILE = "cumulative_totals.txt";

    // ---------- Backend state ----------
    private final Map<Integer, Ticket> tickets = new ConcurrentHashMap<>();
    private final AtomicInteger ticketIdGen = new AtomicInteger(1);
    private final AtomicInteger bookingIdGen = new AtomicInteger(1);

    // Session & cumulative counters
    private int sessionId = 1;
    private int sessionUserActions = 0;
    private int sessionAdminActions = 0;
    private int sessionSimActions = 0;

    private int cumulativeUserActions = 0;
    private int cumulativeAdminActions = 0;
    private int cumulativeSimActions = 0;

    // Sound alerts default ON each session
    private boolean soundAlerts = true;

    // GUI components
    private JFrame mainFrame;
    private JTextArea masterLogArea; // shows master log live
    private DefaultTableModel ticketsTableModel;

    // Executor for background tasks
    private final ExecutorService backgroundPool = Executors.newCachedThreadPool();

    // Date formatter
    private final SimpleDateFormat dtFmt = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");

    // Constructor
    public TicketBookingApp() {
        loadSessionId();
        loadCumulativeTotals();
        // initialize some tickets
        for (int i = 1; i <= 5; i++) addTicketInternal(i, 100 + i); // seatNo, price
        writeSessionHeader();
        SwingUtilities.invokeLater(this::createAndShowGUI);
    }

    // ----------------- Ticket & Booking models -----------------
    private static class Ticket {
        final int ticketId;
        final int seatNo;
        volatile String status; // "AVAILABLE" or "BOOKED"
        final ReentrantLock lock = new ReentrantLock();
        final double price;

        Ticket(int ticketId, int seatNo, double price) {
            this.ticketId = ticketId;
            this.seatNo = seatNo;
            this.price = price;
            this.status = "AVAILABLE";
        }
    }

    private static class Booking {
        final int bookingId;
        final int ticketId;
        final String user;
        final long ts;

        Booking(int bookingId, int ticketId, String user, long ts) {
            this.bookingId = bookingId;
            this.ticketId = ticketId;
            this.user = user;
            this.ts = ts;
        }
    }

    // ----------------- GUI -----------------
    private void createAndShowGUI() {
        mainFrame = new JFrame("Multithreaded Ticket Booking System");
        mainFrame.setDefaultCloseOperation(JFrame.DO_NOTHING_ON_CLOSE);
        mainFrame.setSize(900, 600);
        mainFrame.setLocationRelativeTo(null);
        mainFrame.setLayout(new BorderLayout());

        // Top: Login panel
        JPanel topPanel = new JPanel(new FlowLayout(FlowLayout.CENTER));
        JLabel welcome = new JLabel("<html><h2>Ticket Booking System</h2></html>");
        topPanel.add(welcome);
        mainFrame.add(topPanel, BorderLayout.NORTH);

        // Center: master log area and tickets table side-by-side
        JSplitPane split = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT);
        split.setResizeWeight(0.6);

        // Left: Master log area
        masterLogArea = new JTextArea();
        masterLogArea.setEditable(false);
        JScrollPane logScroll = new JScrollPane(masterLogArea);
        logScroll.setBorder(BorderFactory.createTitledBorder("Master Log (real-time)"));
        split.setLeftComponent(logScroll);

        // Right: Tickets table + buttons
        JPanel rightPanel = new JPanel(new BorderLayout());
        ticketsTableModel = new DefaultTableModel(new Object[]{"Ticket ID", "Seat No", "Status", "Price"}, 0) {
            public boolean isCellEditable(int row, int column) { return false; }
        };
        JTable ticketsTable = new JTable(ticketsTableModel);
        refreshTicketsTable();
        JScrollPane tableScroll = new JScrollPane(ticketsTable);
        tableScroll.setBorder(BorderFactory.createTitledBorder("Tickets"));
        rightPanel.add(tableScroll, BorderLayout.CENTER);

        // Buttons under table for quick actions
        JPanel btnPanel = new JPanel(new GridLayout(2, 3, 6, 6));
        JButton loginUserBtn = new JButton("Login as User");
        JButton loginAdminBtn = new JButton("Login as Admin");
        JButton refreshBtn = new JButton("Refresh Tickets");
        JButton viewUserBookingsBtn = new JButton("My Bookings (User)");
        JButton clearLogViewBtn = new JButton("Clear Log View");
        btnPanel.add(loginUserBtn);
        btnPanel.add(loginAdminBtn);
        btnPanel.add(refreshBtn);
        btnPanel.add(viewUserBookingsBtn);
        btnPanel.add(clearLogViewBtn);
        rightPanel.add(btnPanel, BorderLayout.SOUTH);

        split.setRightComponent(rightPanel);
        mainFrame.add(split, BorderLayout.CENTER);

        // Actions
        loginUserBtn.addActionListener(e -> openUserPanel());
        loginAdminBtn.addActionListener(e -> openAdminPanel());
        refreshBtn.addActionListener(e -> refreshTicketsTable());
        viewUserBookingsBtn.addActionListener(e -> showUserBookingsDialog());
        clearLogViewBtn.addActionListener(e -> masterLogArea.setText(""));

        // Window close handling to write session footer
        mainFrame.addWindowListener(new WindowAdapter() {
            public void windowClosing(WindowEvent e) {
                int res = JOptionPane.showConfirmDialog(mainFrame, "Exit system? This will end the session and write logs.", "Confirm Exit", JOptionPane.YES_NO_OPTION);
                if (res == JOptionPane.YES_OPTION) {
                    shutdownAndExit();
                }
            }
        });

        mainFrame.setVisible(true);
        // Load master log into view
        loadMasterLogIntoView();
    }

    // ----------------- User Panel -----------------
    private void openUserPanel() {
        JDialog userDialog = new JDialog(mainFrame, "User Panel", true);
        userDialog.setSize(600, 400);
        userDialog.setLocationRelativeTo(mainFrame);
        userDialog.setLayout(new BorderLayout());

        JPanel top = new JPanel(new FlowLayout(FlowLayout.LEFT));
        JLabel nameLabel = new JLabel("Your name:");
        JTextField nameField = new JTextField(20);
        top.add(nameLabel);
        top.add(nameField);
        userDialog.add(top, BorderLayout.NORTH);

        // Tickets table copy
        DefaultTableModel userTableModel = new DefaultTableModel(new Object[]{"Ticket ID", "Seat No", "Status", "Price"}, 0) {
            public boolean isCellEditable(int row, int column) { return false; }
        };
        JTable userTable = new JTable(userTableModel);
        refreshModelFromTickets(userTableModel);
        JScrollPane sp = new JScrollPane(userTable);
        userDialog.add(sp, BorderLayout.CENTER);

        JPanel buttons = new JPanel(new FlowLayout(FlowLayout.CENTER));
        JButton refresh = new JButton("Refresh");
        JButton book = new JButton("Book Selected");
        JButton cancel = new JButton("Cancel Selected");
        JButton close = new JButton("Close");
        buttons.add(refresh);
        buttons.add(book);
        buttons.add(cancel);
        buttons.add(close);
        userDialog.add(buttons, BorderLayout.SOUTH);

        refresh.addActionListener(e -> refreshModelFromTickets(userTableModel));
        close.addActionListener(e -> userDialog.dispose());

        book.addActionListener(e -> {
            String user = nameField.getText().trim();
            if (user.isEmpty()) { JOptionPane.showMessageDialog(userDialog, "Enter your name first."); return; }
            int sel = userTable.getSelectedRow();
            if (sel < 0) { JOptionPane.showMessageDialog(userDialog, "Select a ticket to book."); return; }
            int ticketId = (int) userTableModel.getValueAt(sel, 0);
            backgroundPool.submit(() -> {
                boolean ok = attemptBooking(user, ticketId);
                SwingUtilities.invokeLater(() -> {
                    if (ok) JOptionPane.showMessageDialog(userDialog, "Booking confirmed for ticket #" + ticketId);
                    else JOptionPane.showMessageDialog(userDialog, "Failed to book ticket #" + ticketId);
                    refreshModelFromTickets(userTableModel);
                    refreshTicketsTable();
                    loadMasterLogIntoView();
                });
            });
        });

        cancel.addActionListener(e -> {
            String user = nameField.getText().trim();
            if (user.isEmpty()) { JOptionPane.showMessageDialog(userDialog, "Enter your name first."); return; }
            int sel = userTable.getSelectedRow();
            if (sel < 0) { JOptionPane.showMessageDialog(userDialog, "Select a ticket to cancel."); return; }
            int ticketId = (int) userTableModel.getValueAt(sel, 0);
            backgroundPool.submit(() -> {
                boolean ok = attemptCancel(user, ticketId);
                SwingUtilities.invokeLater(() -> {
                    if (ok) JOptionPane.showMessageDialog(userDialog, "Cancellation successful for ticket #" + ticketId);
                    else JOptionPane.showMessageDialog(userDialog, "Failed to cancel ticket #" + ticketId + ". You can only cancel your own booked tickets.");
                    refreshModelFromTickets(userTableModel);
                    refreshTicketsTable();
                    loadMasterLogIntoView();
                });
            });
        });

        userDialog.setVisible(true);
    }

    // ----------------- Admin Panel -----------------
    private void openAdminPanel() {
        JDialog adminDialog = new JDialog(mainFrame, "Admin Panel", true);
        adminDialog.setSize(700, 500);
        adminDialog.setLocationRelativeTo(mainFrame);
        adminDialog.setLayout(new BorderLayout());

        // Top: sound status & buttons
        JPanel top = new JPanel(new FlowLayout(FlowLayout.LEFT));
        JLabel soundStatus = new JLabel("Sound Alerts: " + (soundAlerts ? "ON" : "OFF"));
        JButton toggleSoundBtn = new JButton("Toggle Sound");
        top.add(soundStatus);
        top.add(toggleSoundBtn);
        adminDialog.add(top, BorderLayout.NORTH);

        // Center: tickets table
        DefaultTableModel adminTableModel = new DefaultTableModel(new Object[]{"Ticket ID", "Seat No", "Status", "Price"}, 0) {
            public boolean isCellEditable(int row, int column) { return false; }
        };
        JTable adminTable = new JTable(adminTableModel);
        refreshModelFromTickets(adminTableModel);
        JScrollPane tableScroll = new JScrollPane(adminTable);
        adminDialog.add(tableScroll, BorderLayout.CENTER);

        // Bottom buttons
        JPanel bottom = new JPanel(new FlowLayout(FlowLayout.CENTER));
        JButton addTicketsBtn = new JButton("Add Tickets");
        JButton viewAllBookingsBtn = new JButton("View Bookings");
        JButton runSimBtn = new JButton("Run Simulation");
        JButton openLogsBtn = new JButton("Open Logs Folder");
        JButton closeBtn = new JButton("Close");
        bottom.add(addTicketsBtn);
        bottom.add(viewAllBookingsBtn);
        bottom.add(runSimBtn);
        bottom.add(openLogsBtn);
        bottom.add(closeBtn);
        adminDialog.add(bottom, BorderLayout.SOUTH);

        // Actions
        toggleSoundBtn.addActionListener(e -> {
            soundAlerts = !soundAlerts;
            soundStatus.setText("Sound Alerts: " + (soundAlerts ? "ON" : "OFF"));
            String msg = soundAlerts ? "enabled" : "disabled";
            logAdmin("Admin " + msg + " Sound Alerts");
            logMaster("[ADMIN] Admin " + msg + " Sound Alerts");
            sessionAdminActions++;
            // immediate visual notice
            JOptionPane.showMessageDialog(adminDialog, "Sound Alerts " + (soundAlerts ? "enabled" : "disabled"));
            loadMasterLogIntoView();
        });

        addTicketsBtn.addActionListener(e -> {
            String s = JOptionPane.showInputDialog(adminDialog, "How many tickets to add?");
            if (s == null) return;
            try {
                int n = Integer.parseInt(s);
                backgroundPool.submit(() -> {
                    addTicketsInternal(n);
                    logAdmin("Added " + n + " new tickets");
                    logMaster("[ADMIN] Added " + n + " new tickets");
                    sessionAdminActions++;
                    SwingUtilities.invokeLater(() -> {
                        refreshModelFromTickets(adminTableModel);
                        refreshTicketsTable();
                        loadMasterLogIntoView();
                        if (soundAlerts) Toolkit.getDefaultToolkit().beep();
                    });
                });
            } catch (NumberFormatException ex) {
                JOptionPane.showMessageDialog(adminDialog, "Enter a valid integer.");
            }
        });

        viewAllBookingsBtn.addActionListener(e -> {
            StringBuilder sb = new StringBuilder();
            for (Ticket t : tickets.values()) {
                if ("BOOKED".equals(t.status)) sb.append("Ticket #").append(t.ticketId).append(" seat ").append(t.seatNo).append("\n");
            }
            if (sb.length() == 0) sb.append("No bookings.");
            JOptionPane.showMessageDialog(adminDialog, sb.toString(), "All Bookings", JOptionPane.INFORMATION_MESSAGE);
            logAdmin("Viewed all bookings");
            logMaster("[ADMIN] Viewed all bookings");
            sessionAdminActions++;
            loadMasterLogIntoView();
        });

        runSimBtn.addActionListener(e -> {
            String tidStr = JOptionPane.showInputDialog(adminDialog, "Enter ticketId to target (or leave empty to let simulation pick an available ticket):");
            String threadsStr = JOptionPane.showInputDialog(adminDialog, "Enter number of threads:");
            if (threadsStr == null) return;
            int threads;
            try { threads = Integer.parseInt(threadsStr); }
            catch (NumberFormatException ex) { JOptionPane.showMessageDialog(adminDialog, "Invalid thread count"); return; }
            backgroundPool.submit(() -> {
                int targetTid = -1;
                if (tidStr != null && !tidStr.trim().isEmpty()) {
                    try { targetTid = Integer.parseInt(tidStr.trim()); }
                    catch (NumberFormatException ex) { targetTid = -1; }
                }
                runSimulation(targetTid, threads);
                SwingUtilities.invokeLater(() -> {
                    refreshModelFromTickets(adminTableModel);
                    refreshTicketsTable();
                    loadMasterLogIntoView();
                });
            });
        });

        openLogsBtn.addActionListener(e -> {
            try {
                Desktop.getDesktop().open(new File("."));
            } catch (IOException ex) {
                JOptionPane.showMessageDialog(adminDialog, "Cannot open logs folder: " + ex.getMessage());
            }
        });

        closeBtn.addActionListener(e -> adminDialog.dispose());

        adminDialog.setVisible(true);
    }

    // ----------------- Backend operations -----------------

    // Add new tickets (admin)
    private void addTicketsInternal(int n) {
        for (int i = 0; i < n; i++) {
            addTicketInternal(ticketIdGen.getAndIncrement(), 100.0 + ticketIdGen.get());
        }
    }

    // Low-level add: seatNo used for human-readable seat, here use ticketId as seatNo for simplicity
    private void addTicketInternal(int seatNo, double price) {
        int id = ticketIdGen.getAndIncrement();
        Ticket t = new Ticket(id, seatNo, price);
        tickets.put(id, t);
    }

    // Attempt booking; returns true on success
    private boolean attemptBooking(String username, int ticketId) {
        Ticket t = tickets.get(ticketId);
        if (t == null) {
            logUser(username + " attempted booking on missing ticket #" + ticketId + " -> FAILED");
            logMaster("[USER] " + username + " attempted booking on missing ticket #" + ticketId + " -> FAILED");
            sessionUserActions++;
            return false;
        }
        boolean locked = false;
        try {
            locked = t.lock.tryLock(500, TimeUnit.MILLISECONDS);
            if (!locked) {
                logUser(username + " attempt booking ticket #" + ticketId + " -> FAILED (couldn't acquire lock)");
                logMaster("[USER] " + username + " attempt booking ticket #" + ticketId + " -> FAILED");
                sessionUserActions++;
                return false;
            }
            if (!"AVAILABLE".equals(t.status)) {
                logUser(username + " attempt booking ticket #" + ticketId + " -> FAILED (not available)");
                logMaster("[USER] " + username + " attempt booking ticket #" + ticketId + " -> FAILED");
                sessionUserActions++;
                return false;
            }
            // reserve -> book
            t.status = "BOOKED";
            int bid = bookingIdGen.getAndIncrement();
            logUser(username + " booked Ticket #" + ticketId + " -> CONFIRMED (bookingId " + bid + ")");
            logMaster("[USER] " + username + " booked Ticket #" + ticketId + " -> CONFIRMED");
            sessionUserActions++;
            return true;
        } catch (InterruptedException ex) {
            Thread.currentThread().interrupt();
            return false;
        } finally {
            if (locked) t.lock.unlock();
        }
    }

    // Attempt cancel; only allows cancel if ticket is BOOKED (we don't track booking owner to simplify)
    // To mirror earlier behavior where user can cancel own booking, we would need to store ownership.
    // Here, for GUI demo, cancellation will set BOOKED -> AVAILABLE (admin/user permitted)
    private boolean attemptCancel(String username, int ticketId) {
        Ticket t = tickets.get(ticketId);
        if (t == null) {
            logUser(username + " attempted cancel on missing ticket #" + ticketId + " -> FAILED");
            logMaster("[USER] " + username + " attempted cancel on missing ticket #" + ticketId + " -> FAILED");
            sessionUserActions++;
            return false;
        }
        boolean locked = false;
        try {
            locked = t.lock.tryLock(500, TimeUnit.MILLISECONDS);
            if (!locked) {
                logUser(username + " attempt cancel ticket #" + ticketId + " -> FAILED (couldn't acquire lock)");
                logMaster("[USER] " + username + " attempt cancel ticket #" + ticketId + " -> FAILED");
                sessionUserActions++;
                return false;
            }
            if (!"BOOKED".equals(t.status)) {
                logUser(username + " attempt cancel ticket #" + ticketId + " -> FAILED (not booked)");
                logMaster("[USER] " + username + " attempt cancel ticket #" + ticketId + " -> FAILED");
                sessionUserActions++;
                return false;
            }
            t.status = "AVAILABLE";
            logUser(username + " cancelled Ticket #" + ticketId + " -> SUCCESS");
            logMaster("[USER] " + username + " cancelled Ticket #" + ticketId + " -> SUCCESS");
            sessionUserActions++;
            return true;
        } catch (InterruptedException ex) {
            Thread.currentThread().interrupt();
            return false;
        } finally {
            if (locked) t.lock.unlock();
        }
    }

    // ----------------- Simulation -----------------
    // If targetTicketId == -1, pick first available
    private void runSimulation(int targetTicketId, int numThreads) {
        // pick target ticket
        int chosen = targetTicketId;
        if (chosen <= 0) {
            for (Ticket t : tickets.values()) {
                if ("AVAILABLE".equals(t.status)) { chosen = t.ticketId; break; }
            }
        }
        if (chosen <= 0) {
            // nothing available -> create new tickets and target the first added
            addTicketsInternal(1);
            chosen = ticketIdGen.get() - 1;
        }

        final int target = chosen;
        // write simulation start to admin log + master
        logAdmin("Started simulation for ticket #" + target + " with threads=" + numThreads);
        logMaster("[ADMIN] Started simulation for ticket #" + target + " with threads=" + numThreads);
        sessionAdminActions++;

        // run threads
        CountDownLatch latch = new CountDownLatch(numThreads);
        for (int i = 0; i < numThreads; i++) {
            final int threadNum = i + 1;
            backgroundPool.submit(() -> {
                try {
                    // each thread tries to book the target ticket
                    Ticket t = tickets.get(target);
                    if (t == null) {
                        // nothing
                        logSim("Thread-" + threadNum + " target missing -> FAILED");
                        logMaster("[SIMULATION]" + (soundAlerts ? "[ON] " : "[MUTED] ") + "Thread-" + threadNum + " target missing -> FAILED");
                        sessionSimActions++;
                        return;
                    }
                    boolean locked = false;
                    try {
                        locked = t.lock.tryLock(500, TimeUnit.MILLISECONDS);
                        if (!locked) {
                            logSim("Thread-" + threadNum + " couldn't acquire lock -> FAILED");
                            logMaster("[SIMULATION]" + (soundAlerts ? "[ON] " : "[MUTED] ") + "Thread-" + threadNum + " couldn't acquire lock -> FAILED");
                            sessionSimActions++;
                            return;
                        }
                        if (!"AVAILABLE".equals(t.status)) {
                            logSim("Thread-" + threadNum + " found ticket not available -> FAILED");
                            logMaster("[SIMULATION]" + (soundAlerts ? "[ON] " : "[MUTED] ") + "Thread-" + threadNum + " found ticket not available -> FAILED");
                            sessionSimActions++;
                            return;
                        }
                        // simulate processing
                        Thread.sleep(30);
                        t.status = "BOOKED";
                        logSim("Thread-" + threadNum + " booked Ticket #" + target + " -> CONFIRMED");
                        logMaster("[SIMULATION]" + (soundAlerts ? "[ON] " : "[MUTED] ") + "Thread-" + threadNum + " booked Ticket #" + target + " -> CONFIRMED");
                        sessionSimActions++;
                    } catch (InterruptedException ex) {
                        Thread.currentThread().interrupt();
                    } finally {
                        if (locked) t.lock.unlock();
                    }
                } finally {
                    latch.countDown();
                }
            });
        }

        // Wait for simulation to finish
        try {
            latch.await(10, TimeUnit.SECONDS);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        // Write completion logs
        logAdmin("Completed simulation for ticket #" + target + " with threads=" + numThreads);
        logMaster("[ADMIN] Completed simulation for ticket #" + target + " with threads=" + numThreads);
        sessionAdminActions++;
        if (soundAlerts) Toolkit.getDefaultToolkit().beep();
    }

    // ----------------- Logging helpers -----------------
    private void logUser(String entry) {
        appendToFileWithTimestamp(USER_LOG, entry);
    }

    private void logAdmin(String entry) {
        appendToFileWithTimestamp(ADMIN_LOG, entry);
    }

    private void logSim(String entry) {
        appendToFileWithTimestamp(SIM_LOG, entry);
    }

    private void logMaster(String entry) {
        appendToFileWithTimestamp(MASTER_LOG, entryWithTag(entry));
    }

    private String entryWithTag(String entry) {
        // master log entries are stored as-is with prefix made by callers
        return entry;
    }

    private void appendToFileWithTimestamp(String file, String message) {
        String line = "[" + dtFmt.format(new Date()) + "] " + message;
        synchronized (TicketBookingApp.class) {
            try (FileWriter fw = new FileWriter(file, true);
                 BufferedWriter bw = new BufferedWriter(fw);
                 PrintWriter out = new PrintWriter(bw)) {
                out.println(line);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        // if master log, update masterLogArea live
        if (MASTER_LOG.equals(file)) {
            SwingUtilities.invokeLater(() -> masterLogArea.append(line + "\n"));
        }
    }

    // Write session header to all logs
    private void writeSessionHeader() {
        String headerAdmin = String.format("--- SESSION#%d Started at %s (Sound Alerts: %s) ---",
                sessionId, dtFmt.format(new Date()), (soundAlerts ? "ON" : "OFF"));
        String headerOther = String.format("--- SESSION#%d Started at %s ---", sessionId, dtFmt.format(new Date()));
        appendRaw(USER_LOG, headerOther);
        appendRaw(ADMIN_LOG, headerAdmin);
        appendRaw(SIM_LOG, headerOther);
        appendRaw(MASTER_LOG, headerAdmin);
        // also add to GUI view
        SwingUtilities.invokeLater(() -> masterLogArea.append(headerAdmin + "\n"));
    }

    // Write session footer with per-session summary and cumulative totals
    private void writeSessionFooter() {
        // Update cumulative totals
        cumulativeUserActions += sessionUserActions;
        cumulativeAdminActions += sessionAdminActions;
        cumulativeSimActions += sessionSimActions;

        String footerAdmin = String.format("--- SESSION#%d Ended at %s (Final Sound Alerts: %s) ---",
                sessionId, dtFmt.format(new Date()), (soundAlerts ? "ON" : "OFF"));
        String summary = String.format("Summary: %d User action(s), %d Admin action(s), %d Simulation action(s)",
                sessionUserActions, sessionAdminActions, sessionSimActions);
        String cumulative = String.format("Cumulative Totals (all sessions so far):\n- User actions: %d\n- Admin actions: %d\n- Simulation actions: %d",
                cumulativeUserActions, cumulativeAdminActions, cumulativeSimActions);
        appendRaw(USER_LOG, footerAdmin);
        appendRaw(ADMIN_LOG, footerAdmin + "\n" + summary + "\n" + cumulative);
        appendRaw(SIM_LOG, footerAdmin);
        appendRaw(MASTER_LOG, footerAdmin + "\n" + summary + "\n\n" + cumulative + "\n\n");
        SwingUtilities.invokeLater(() -> masterLogArea.append(footerAdmin + "\n" + summary + "\n\n" + cumulative + "\n\n"));
    }

    private void appendRaw(String file, String text) {
        synchronized (TicketBookingApp.class) {
            try (FileWriter fw = new FileWriter(file, true);
                 BufferedWriter bw = new BufferedWriter(fw);
                 PrintWriter out = new PrintWriter(bw)) {
                out.println(text);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }

    // ----------------- Persistence for session id & cumulative totals -----------------
    private void loadSessionId() {
        File f = new File(SESSION_COUNTER_FILE);
        if (f.exists()) {
            try (Scanner sc = new Scanner(f)) {
                if (sc.hasNextInt()) sessionId = sc.nextInt() + 1;
            } catch (Exception e) {
                e.printStackTrace();
            }
        } else {
            sessionId = 1;
        }
    }

    private void saveSessionId() {
        synchronized (TicketBookingApp.class) {
            try (PrintWriter out = new PrintWriter(new FileWriter(SESSION_COUNTER_FILE))) {
                out.println(sessionId);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }

    private void loadCumulativeTotals() {
        File f = new File(CUMULATIVE_FILE);
        if (f.exists()) {
            try (Scanner sc = new Scanner(f)) {
                if (sc.hasNextInt()) cumulativeUserActions = sc.nextInt();
                if (sc.hasNextInt()) cumulativeAdminActions = sc.nextInt();
                if (sc.hasNextInt()) cumulativeSimActions = sc.nextInt();
            } catch (Exception e) {
                e.printStackTrace();
            }
        } else {
            cumulativeUserActions = cumulativeAdminActions = cumulativeSimActions = 0;
        }
    }

    private void saveCumulativeTotals() {
        synchronized (TicketBookingApp.class) {
            try (PrintWriter out = new PrintWriter(new FileWriter(CUMULATIVE_FILE))) {
                out.println(cumulativeUserActions + " " + cumulativeAdminActions + " " + cumulativeSimActions);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }

    // ----------------- Utility UI & file viewers -----------------
    private void refreshTicketsTable() {
        // refresh the central tickets table (in main GUI)
        SwingUtilities.invokeLater(() -> {
            // find the table model in the main frame by walking components
            Component[] comps = mainFrame.getContentPane().getComponents();
            // the split pane is at center
            for (Component c : comps) {
                if (c instanceof JSplitPane) {
                    JSplitPane sp = (JSplitPane) c;
                    Component right = sp.getRightComponent();
                    if (right instanceof JPanel) {
                        JPanel rp = (JPanel) right;
                        for (Component inner : rp.getComponents()) {
                            if (inner instanceof JScrollPane) {
                                JScrollPane jsp = (JScrollPane) inner;
                                if (jsp.getViewport().getView() instanceof JTable) {
                                    JTable tbl = (JTable) jsp.getViewport().getView();
                                    if (tbl.getModel() instanceof DefaultTableModel) {
                                        DefaultTableModel model = (DefaultTableModel) tbl.getModel();
                                        refreshModelFromTickets(model);
                                    }
                                }
                            }
                        }
                    }
                }
            }
        });
    }

    private void refreshModelFromTickets(DefaultTableModel model) {
        SwingUtilities.invokeLater(() -> {
            model.setRowCount(0);
            List<Ticket> list = new ArrayList<>(tickets.values());
            list.sort(Comparator.comparingInt(a -> a.ticketId));
            for (Ticket t : list) {
                model.addRow(new Object[]{t.ticketId, t.seatNo, t.status, t.price});
            }
        });
    }

    private void showUserBookingsDialog() {
        StringBuilder sb = new StringBuilder();
        for (Ticket t : tickets.values()) {
            if ("BOOKED".equals(t.status)) sb.append("Ticket #").append(t.ticketId).append(" seat ").append(t.seatNo).append("\n");
        }
        if (sb.length() == 0) sb.append("You have no bookings recorded (this demo does not track ownership).");
        JOptionPane.showMessageDialog(mainFrame, sb.toString(), "Bookings", JOptionPane.INFORMATION_MESSAGE);
    }

    private void loadMasterLogIntoView() {
        SwingUtilities.invokeLater(() -> {
            try (BufferedReader br = new BufferedReader(new FileReader(MASTER_LOG))) {
                masterLogArea.setText("");
                String line;
                while ((line = br.readLine()) != null) masterLogArea.append(line + "\n");
            } catch (IOException e) {
                // ignore if file doesn't exist yet
            }
        });
    }

    // ----------------- Shutdown -----------------
    private void shutdownAndExit() {
        // write footer and persist counts
        writeSessionFooter();
        // update session counter and cumulative totals files
        saveCumulativeTotals();
        saveSessionId();
        // close background pool
        backgroundPool.shutdownNow();
        // increment sessionId for next run
        sessionId++;
        // exit
        System.exit(0);
    }

    // ----------------- Main -----------------
    public static void main(String[] args) {
        new TicketBookingApp();
    }
}